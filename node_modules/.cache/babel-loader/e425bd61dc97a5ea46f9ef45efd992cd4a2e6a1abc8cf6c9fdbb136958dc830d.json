{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.PopupManager = void 0;\nconst tslib_1 = require(\"tslib\");\nconst events_1 = tslib_1.__importDefault(require(\"events\"));\nconst utils_1 = require(\"@trezor/utils\");\nconst events_2 = require(\"@trezor/connect/lib/events\");\nconst urlUtils_1 = require(\"@trezor/connect/lib/utils/urlUtils\");\nconst showPopupRequest_1 = require(\"./showPopupRequest\");\nconst serviceworker_window_1 = require(\"../channels/serviceworker-window\");\nconst window_window_1 = require(\"../channels/window-window\");\nconst checkIfTabExists = tabId => new Promise(resolve => {\n  if (!tabId) return resolve(false);\n  function callback() {\n    if (chrome.runtime.lastError) {\n      resolve(false);\n    } else {\n      resolve(true);\n    }\n  }\n  chrome.tabs.get(tabId, callback);\n});\nconst POPUP_REQUEST_TIMEOUT = 850;\nconst POPUP_CLOSE_INTERVAL = 500;\nconst POPUP_OPEN_TIMEOUT = 5000;\nclass PopupManager extends events_1.default {\n  constructor(settings, {\n    logger\n  }) {\n    var _a;\n    super();\n    this.locked = false;\n    this.extensionTabId = 0;\n    this.injectContentScript = tabId => {\n      chrome.permissions.getAll(permissions => {\n        var _a;\n        if ((_a = permissions.permissions) === null || _a === void 0 ? void 0 : _a.includes('scripting')) {\n          (0, utils_1.scheduleAction)(() => chrome.scripting.executeScript({\n            target: {\n              tabId\n            },\n            func: () => {}\n          }).then(() => {\n            this.logger.debug('content script injected');\n          }).catch(error => {\n            this.logger.error('content script injection error', error);\n            throw error;\n          }), {\n            attempts: new Array(3).fill({\n              timeout: 100\n            })\n          });\n        } else {}\n      });\n    };\n    this.settings = settings;\n    this.origin = (0, urlUtils_1.getOrigin)(settings.popupSrc);\n    this.logger = logger;\n    if (this.isWebExtensionWithTab()) {\n      this.channel = new serviceworker_window_1.ServiceWorkerWindowChannel({\n        name: 'trezor-connect',\n        channel: {\n          here: '@trezor/connect-webextension',\n          peer: '@trezor/connect-content-script'\n        },\n        logger,\n        currentId: () => {\n          var _a, _b;\n          if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'tab') return (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.tab.id;\n        },\n        legacyMode: !this.settings.useCoreInPopup\n      });\n    } else {\n      this.channel = new window_window_1.WindowWindowChannel({\n        windowHere: window,\n        windowPeer: () => {\n          var _a, _b;\n          if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'window') return (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.window;\n        },\n        channel: {\n          here: '@trezor/connect-web',\n          peer: '@trezor/connect-popup'\n        },\n        logger,\n        origin: this.origin,\n        legacyMode: !this.settings.useCoreInPopup\n      });\n    }\n    if (!this.settings.useCoreInPopup) {\n      this.iframeHandshakePromise = (0, utils_1.createDeferred)(events_2.IFRAME.LOADED);\n      this.channelIframe = new window_window_1.WindowWindowChannel({\n        windowHere: window,\n        windowPeer: () => window,\n        channel: {\n          here: '@trezor/connect-web',\n          peer: '@trezor/connect-iframe'\n        },\n        logger,\n        origin: this.origin\n      });\n      (_a = this.channelIframe) === null || _a === void 0 ? void 0 : _a.on('message', this.handleMessage.bind(this));\n    }\n    if (this.settings.useCoreInPopup) {\n      this.handshakePromise = (0, utils_1.createDeferred)();\n      this.channel.on('message', this.handleCoreMessage.bind(this));\n      return;\n    } else if (this.isWebExtensionWithTab()) {\n      this.channel.on('message', this.handleExtensionMessage.bind(this));\n    } else {\n      this.channel.on('message', this.handleMessage.bind(this));\n    }\n    this.channel.init();\n  }\n  async request() {\n    var _a, _b, _c, _d, _f;\n    if (this.settings.useCoreInPopup && ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'tab') {\n      const currentPopupExists = await checkIfTabExists((_c = (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.tab) === null || _c === void 0 ? void 0 : _c.id);\n      if (!currentPopupExists) {\n        this.clear();\n      }\n    }\n    if (this.locked) {\n      if (((_d = this.popupWindow) === null || _d === void 0 ? void 0 : _d.mode) === 'tab' && this.popupWindow.tab.id) {\n        chrome.tabs.update(this.popupWindow.tab.id, {\n          active: true\n        });\n      } else if (((_f = this.popupWindow) === null || _f === void 0 ? void 0 : _f.mode) === 'window') {\n        this.popupWindow.window.focus();\n      }\n      return;\n    }\n    if (this.popupWindow && !this.locked) {\n      this.close();\n    }\n    const openFn = this.open.bind(this);\n    this.locked = true;\n    const timeout = this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n    this.requestTimeout = setTimeout(() => {\n      this.requestTimeout = undefined;\n      openFn();\n    }, timeout);\n  }\n  unlock() {\n    this.locked = false;\n  }\n  open() {\n    const src = this.settings.popupSrc;\n    this.popupPromise = (0, utils_1.createDeferred)(events_2.POPUP.LOADED);\n    this.openWrapper(src);\n    if (this.settings.useCoreInPopup) {\n      return;\n    }\n    this.closeInterval = setInterval(() => {\n      if (!this.popupWindow) return;\n      if (this.popupWindow.mode === 'tab' && this.popupWindow.tab.id) {\n        chrome.tabs.get(this.popupWindow.tab.id, tab => {\n          if (!tab) {\n            this.emitClosed();\n            this.clear();\n          }\n        });\n      } else if (this.popupWindow.mode === 'window' && this.popupWindow.window.closed) {\n        this.clear();\n        this.emitClosed();\n      }\n    }, POPUP_CLOSE_INTERVAL);\n    if (this.settings.useCoreInPopup) {\n      return;\n    }\n    this.openTimeout = setTimeout(() => {\n      this.clear();\n      (0, showPopupRequest_1.showPopupRequest)(this.open.bind(this), () => {\n        this.emitClosed();\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  }\n  openWrapper(url) {\n    if (this.isWebExtensionWithTab()) {\n      chrome.windows.getCurrent(currentWindow => {\n        this.logger.debug('opening popup. currentWindow: ', currentWindow);\n        if (currentWindow.type !== 'normal') {\n          chrome.windows.create({\n            url\n          }, newWindow => {\n            chrome.tabs.query({\n              windowId: newWindow === null || newWindow === void 0 ? void 0 : newWindow.id,\n              active: true\n            }, tabs => {\n              this.popupWindow = {\n                mode: 'tab',\n                tab: tabs[0]\n              };\n              this.injectContentScript(tabs[0].id);\n            });\n          });\n        } else {\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, tabs => {\n            this.extensionTabId = tabs[0].id;\n            chrome.tabs.create({\n              url,\n              index: tabs[0].index + 1\n            }, tab => {\n              this.popupWindow = {\n                mode: 'tab',\n                tab\n              };\n              this.injectContentScript(tab.id);\n            });\n          });\n        }\n      });\n    } else {\n      const windowResult = window.open(url, 'modal');\n      if (!windowResult) return;\n      this.popupWindow = {\n        mode: 'window',\n        window: windowResult\n      };\n    }\n    if (!this.channel.isConnected) {\n      this.channel.connect();\n    }\n  }\n  handleCoreMessage(message) {\n    var _a;\n    if (message.type === events_2.POPUP.BOOTSTRAP) {\n      this.channel.init();\n    } else if (message.type === events_2.POPUP.LOADED) {\n      this.handleMessage(message);\n      this.channel.postMessage({\n        type: events_2.POPUP.INIT,\n        payload: {\n          settings: this.settings,\n          useCore: true\n        }\n      });\n    } else if (message.type === events_2.POPUP.CORE_LOADED) {\n      this.channel.postMessage({\n        type: events_2.POPUP.HANDSHAKE,\n        payload: {\n          settings: this.settings\n        }\n      });\n      (_a = this.handshakePromise) === null || _a === void 0 ? void 0 : _a.resolve();\n    } else if (message.type === events_2.POPUP.CLOSED) {\n      this.emitClosed();\n    }\n  }\n  handleExtensionMessage(data) {\n    if (data.type === events_2.POPUP.ERROR || data.type === events_2.POPUP.LOADED || data.type === events_2.POPUP.BOOTSTRAP) {\n      this.handleMessage(data);\n    } else if (data.type === events_2.POPUP.EXTENSION_USB_PERMISSIONS) {\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, tabs => {\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, _tab => {});\n      });\n    } else if (data.type === events_2.POPUP.CLOSE_WINDOW) {\n      this.clear();\n    }\n  }\n  handleMessage(data) {\n    var _a, _b;\n    if (data.type === events_2.IFRAME.LOADED) {\n      (_a = this.iframeHandshakePromise) === null || _a === void 0 ? void 0 : _a.resolve(data.payload);\n    } else if (data.type === events_2.POPUP.BOOTSTRAP) {\n      if (this.openTimeout) clearTimeout(this.openTimeout);\n    } else if (data.type === events_2.POPUP.ERROR && this.popupWindow) {\n      const errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(events_2.POPUP.CLOSED, errorMessage ? `Popup error: ${errorMessage}` : null);\n      this.clear();\n    } else if (data.type === events_2.POPUP.LOADED) {\n      if (this.openTimeout) clearTimeout(this.openTimeout);\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n        this.popupPromise = undefined;\n      }\n      (_b = this.iframeHandshakePromise) === null || _b === void 0 ? void 0 : _b.promise.then(payload => {\n        this.channel.postMessage({\n          type: events_2.POPUP.INIT,\n          payload: Object.assign(Object.assign({}, payload), {\n            settings: this.settings\n          })\n        });\n      });\n    } else if (data.type === events_2.POPUP.CANCEL_POPUP_REQUEST) {\n      clearTimeout(this.requestTimeout);\n      if (this.popupPromise) {\n        this.close();\n      }\n    } else if (data.type === events_2.UI.CLOSE_UI_WINDOW) {\n      this.clear(false);\n    }\n  }\n  clear(focus = true) {\n    this.locked = false;\n    this.popupPromise = undefined;\n    this.handshakePromise = (0, utils_1.createDeferred)();\n    if (this.channel) {\n      this.channel.disconnect();\n    }\n    if (this.requestTimeout) {\n      clearTimeout(this.requestTimeout);\n      this.requestTimeout = undefined;\n    }\n    if (this.openTimeout) {\n      clearTimeout(this.openTimeout);\n      this.openTimeout = undefined;\n    }\n    if (this.closeInterval) {\n      clearInterval(this.closeInterval);\n      this.closeInterval = undefined;\n    }\n    if (focus && this.extensionTabId) {\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n  }\n  close() {\n    var _a;\n    if (!this.popupWindow) return;\n    this.logger.debug('closing popup');\n    if (this.popupWindow.mode === 'tab') {\n      let _e = chrome.runtime.lastError;\n      if (this.popupWindow.tab.id) {\n        chrome.tabs.remove(this.popupWindow.tab.id, () => {\n          _e = chrome.runtime.lastError;\n          if (_e) {\n            this.logger.error('closed with error', _e);\n          }\n        });\n      }\n    } else if (this.popupWindow.mode === 'window') {\n      this.popupWindow.window.close();\n    }\n    this.popupWindow = undefined;\n    if ((_a = this.settings) === null || _a === void 0 ? void 0 : _a.useCoreInPopup) {\n      this.channel.clear();\n    }\n  }\n  async postMessage(message) {\n    var _a, _b;\n    if (!this.popupWindow && message.type !== events_2.UI.REQUEST_UI_WINDOW && this.openTimeout) {\n      this.clear();\n      (0, showPopupRequest_1.showPopupRequest)(this.open.bind(this), () => {\n        this.emitClosed();\n      });\n      return;\n    }\n    if (this.popupPromise) {\n      await this.popupPromise.promise;\n    }\n    if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'window') {\n      this.popupWindow.window.postMessage(message, this.origin);\n    } else if (((_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.mode) === 'tab') {\n      this.channel.postMessage(message);\n    }\n  }\n  isWebExtensionWithTab() {\n    var _a;\n    return ((_a = this.settings) === null || _a === void 0 ? void 0 : _a.env) === 'webextension' && typeof chrome !== 'undefined' && typeof (chrome === null || chrome === void 0 ? void 0 : chrome.tabs) !== 'undefined';\n  }\n  emitClosed() {\n    var _a;\n    if ((_a = this.settings) === null || _a === void 0 ? void 0 : _a.useCoreInPopup) {\n      this.channel.resolveMessagePromises({\n        code: 'Method_Interrupted',\n        error: events_2.POPUP.CLOSED\n      });\n    }\n    this.emit(events_2.POPUP.CLOSED);\n  }\n}\nexports.PopupManager = PopupManager;","map":{"version":3,"names":["Object","defineProperty","exports","value","PopupManager","tslib_1","require","events_1","__importDefault","utils_1","events_2","urlUtils_1","showPopupRequest_1","serviceworker_window_1","window_window_1","checkIfTabExists","tabId","Promise","resolve","callback","chrome","runtime","lastError","tabs","get","POPUP_REQUEST_TIMEOUT","POPUP_CLOSE_INTERVAL","POPUP_OPEN_TIMEOUT","default","constructor","settings","logger","_a","locked","extensionTabId","injectContentScript","permissions","getAll","includes","scheduleAction","scripting","executeScript","target","func","then","debug","catch","error","attempts","Array","fill","timeout","origin","getOrigin","popupSrc","isWebExtensionWithTab","channel","ServiceWorkerWindowChannel","name","here","peer","currentId","_b","popupWindow","mode","tab","id","legacyMode","useCoreInPopup","WindowWindowChannel","windowHere","window","windowPeer","iframeHandshakePromise","createDeferred","IFRAME","LOADED","channelIframe","on","handleMessage","bind","handshakePromise","handleCoreMessage","handleExtensionMessage","init","request","_c","_d","_f","currentPopupExists","clear","update","active","focus","close","openFn","open","env","requestTimeout","setTimeout","undefined","unlock","src","popupPromise","POPUP","openWrapper","closeInterval","setInterval","emitClosed","closed","openTimeout","showPopupRequest","url","windows","getCurrent","currentWindow","type","create","newWindow","query","windowId","index","windowResult","isConnected","connect","message","BOOTSTRAP","postMessage","INIT","payload","useCore","CORE_LOADED","HANDSHAKE","CLOSED","data","ERROR","EXTENSION_USB_PERMISSIONS","_tab","CLOSE_WINDOW","clearTimeout","errorMessage","emit","promise","assign","CANCEL_POPUP_REQUEST","UI","CLOSE_UI_WINDOW","disconnect","clearInterval","_e","remove","REQUEST_UI_WINDOW","resolveMessagePromises","code"],"sources":["/Users/boraoz/Desktop/nft-marketplace/node_modules/@trezor/connect-web/lib/popup/index.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.PopupManager = void 0;\nconst tslib_1 = require(\"tslib\");\nconst events_1 = tslib_1.__importDefault(require(\"events\"));\nconst utils_1 = require(\"@trezor/utils\");\nconst events_2 = require(\"@trezor/connect/lib/events\");\nconst urlUtils_1 = require(\"@trezor/connect/lib/utils/urlUtils\");\nconst showPopupRequest_1 = require(\"./showPopupRequest\");\nconst serviceworker_window_1 = require(\"../channels/serviceworker-window\");\nconst window_window_1 = require(\"../channels/window-window\");\nconst checkIfTabExists = (tabId) => new Promise(resolve => {\n    if (!tabId)\n        return resolve(false);\n    function callback() {\n        if (chrome.runtime.lastError) {\n            resolve(false);\n        }\n        else {\n            resolve(true);\n        }\n    }\n    chrome.tabs.get(tabId, callback);\n});\nconst POPUP_REQUEST_TIMEOUT = 850;\nconst POPUP_CLOSE_INTERVAL = 500;\nconst POPUP_OPEN_TIMEOUT = 5000;\nclass PopupManager extends events_1.default {\n    constructor(settings, { logger }) {\n        var _a;\n        super();\n        this.locked = false;\n        this.extensionTabId = 0;\n        this.injectContentScript = (tabId) => {\n            chrome.permissions.getAll(permissions => {\n                var _a;\n                if ((_a = permissions.permissions) === null || _a === void 0 ? void 0 : _a.includes('scripting')) {\n                    (0, utils_1.scheduleAction)(() => chrome.scripting\n                        .executeScript({\n                        target: { tabId },\n                        func: () => {\n                        },\n                    })\n                        .then(() => {\n                        this.logger.debug('content script injected');\n                    })\n                        .catch(error => {\n                        this.logger.error('content script injection error', error);\n                        throw error;\n                    }), { attempts: new Array(3).fill({ timeout: 100 }) });\n                }\n                else {\n                }\n            });\n        };\n        this.settings = settings;\n        this.origin = (0, urlUtils_1.getOrigin)(settings.popupSrc);\n        this.logger = logger;\n        if (this.isWebExtensionWithTab()) {\n            this.channel = new serviceworker_window_1.ServiceWorkerWindowChannel({\n                name: 'trezor-connect',\n                channel: {\n                    here: '@trezor/connect-webextension',\n                    peer: '@trezor/connect-content-script',\n                },\n                logger,\n                currentId: () => {\n                    var _a, _b;\n                    if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'tab')\n                        return (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.tab.id;\n                },\n                legacyMode: !this.settings.useCoreInPopup,\n            });\n        }\n        else {\n            this.channel = new window_window_1.WindowWindowChannel({\n                windowHere: window,\n                windowPeer: () => {\n                    var _a, _b;\n                    if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'window')\n                        return (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.window;\n                },\n                channel: {\n                    here: '@trezor/connect-web',\n                    peer: '@trezor/connect-popup',\n                },\n                logger,\n                origin: this.origin,\n                legacyMode: !this.settings.useCoreInPopup,\n            });\n        }\n        if (!this.settings.useCoreInPopup) {\n            this.iframeHandshakePromise = (0, utils_1.createDeferred)(events_2.IFRAME.LOADED);\n            this.channelIframe = new window_window_1.WindowWindowChannel({\n                windowHere: window,\n                windowPeer: () => window,\n                channel: {\n                    here: '@trezor/connect-web',\n                    peer: '@trezor/connect-iframe',\n                },\n                logger,\n                origin: this.origin,\n            });\n            (_a = this.channelIframe) === null || _a === void 0 ? void 0 : _a.on('message', this.handleMessage.bind(this));\n        }\n        if (this.settings.useCoreInPopup) {\n            this.handshakePromise = (0, utils_1.createDeferred)();\n            this.channel.on('message', this.handleCoreMessage.bind(this));\n            return;\n        }\n        else if (this.isWebExtensionWithTab()) {\n            this.channel.on('message', this.handleExtensionMessage.bind(this));\n        }\n        else {\n            this.channel.on('message', this.handleMessage.bind(this));\n        }\n        this.channel.init();\n    }\n    async request() {\n        var _a, _b, _c, _d, _f;\n        if (this.settings.useCoreInPopup && ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'tab') {\n            const currentPopupExists = await checkIfTabExists((_c = (_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.tab) === null || _c === void 0 ? void 0 : _c.id);\n            if (!currentPopupExists) {\n                this.clear();\n            }\n        }\n        if (this.locked) {\n            if (((_d = this.popupWindow) === null || _d === void 0 ? void 0 : _d.mode) === 'tab' && this.popupWindow.tab.id) {\n                chrome.tabs.update(this.popupWindow.tab.id, { active: true });\n            }\n            else if (((_f = this.popupWindow) === null || _f === void 0 ? void 0 : _f.mode) === 'window') {\n                this.popupWindow.window.focus();\n            }\n            return;\n        }\n        if (this.popupWindow && !this.locked) {\n            this.close();\n        }\n        const openFn = this.open.bind(this);\n        this.locked = true;\n        const timeout = this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n        this.requestTimeout = setTimeout(() => {\n            this.requestTimeout = undefined;\n            openFn();\n        }, timeout);\n    }\n    unlock() {\n        this.locked = false;\n    }\n    open() {\n        const src = this.settings.popupSrc;\n        this.popupPromise = (0, utils_1.createDeferred)(events_2.POPUP.LOADED);\n        this.openWrapper(src);\n        if (this.settings.useCoreInPopup) {\n            return;\n        }\n        this.closeInterval = setInterval(() => {\n            if (!this.popupWindow)\n                return;\n            if (this.popupWindow.mode === 'tab' && this.popupWindow.tab.id) {\n                chrome.tabs.get(this.popupWindow.tab.id, tab => {\n                    if (!tab) {\n                        this.emitClosed();\n                        this.clear();\n                    }\n                });\n            }\n            else if (this.popupWindow.mode === 'window' && this.popupWindow.window.closed) {\n                this.clear();\n                this.emitClosed();\n            }\n        }, POPUP_CLOSE_INTERVAL);\n        if (this.settings.useCoreInPopup) {\n            return;\n        }\n        this.openTimeout = setTimeout(() => {\n            this.clear();\n            (0, showPopupRequest_1.showPopupRequest)(this.open.bind(this), () => {\n                this.emitClosed();\n            });\n        }, POPUP_OPEN_TIMEOUT);\n    }\n    openWrapper(url) {\n        if (this.isWebExtensionWithTab()) {\n            chrome.windows.getCurrent(currentWindow => {\n                this.logger.debug('opening popup. currentWindow: ', currentWindow);\n                if (currentWindow.type !== 'normal') {\n                    chrome.windows.create({ url }, newWindow => {\n                        chrome.tabs.query({\n                            windowId: newWindow === null || newWindow === void 0 ? void 0 : newWindow.id,\n                            active: true,\n                        }, tabs => {\n                            this.popupWindow = { mode: 'tab', tab: tabs[0] };\n                            this.injectContentScript(tabs[0].id);\n                        });\n                    });\n                }\n                else {\n                    chrome.tabs.query({\n                        currentWindow: true,\n                        active: true,\n                    }, tabs => {\n                        this.extensionTabId = tabs[0].id;\n                        chrome.tabs.create({\n                            url,\n                            index: tabs[0].index + 1,\n                        }, tab => {\n                            this.popupWindow = { mode: 'tab', tab };\n                            this.injectContentScript(tab.id);\n                        });\n                    });\n                }\n            });\n        }\n        else {\n            const windowResult = window.open(url, 'modal');\n            if (!windowResult)\n                return;\n            this.popupWindow = { mode: 'window', window: windowResult };\n        }\n        if (!this.channel.isConnected) {\n            this.channel.connect();\n        }\n    }\n    handleCoreMessage(message) {\n        var _a;\n        if (message.type === events_2.POPUP.BOOTSTRAP) {\n            this.channel.init();\n        }\n        else if (message.type === events_2.POPUP.LOADED) {\n            this.handleMessage(message);\n            this.channel.postMessage({\n                type: events_2.POPUP.INIT,\n                payload: {\n                    settings: this.settings,\n                    useCore: true,\n                },\n            });\n        }\n        else if (message.type === events_2.POPUP.CORE_LOADED) {\n            this.channel.postMessage({\n                type: events_2.POPUP.HANDSHAKE,\n                payload: { settings: this.settings },\n            });\n            (_a = this.handshakePromise) === null || _a === void 0 ? void 0 : _a.resolve();\n        }\n        else if (message.type === events_2.POPUP.CLOSED) {\n            this.emitClosed();\n        }\n    }\n    handleExtensionMessage(data) {\n        if (data.type === events_2.POPUP.ERROR ||\n            data.type === events_2.POPUP.LOADED ||\n            data.type === events_2.POPUP.BOOTSTRAP) {\n            this.handleMessage(data);\n        }\n        else if (data.type === events_2.POPUP.EXTENSION_USB_PERMISSIONS) {\n            chrome.tabs.query({\n                currentWindow: true,\n                active: true,\n            }, tabs => {\n                chrome.tabs.create({\n                    url: 'trezor-usb-permissions.html',\n                    index: tabs[0].index + 1,\n                }, _tab => {\n                });\n            });\n        }\n        else if (data.type === events_2.POPUP.CLOSE_WINDOW) {\n            this.clear();\n        }\n    }\n    handleMessage(data) {\n        var _a, _b;\n        if (data.type === events_2.IFRAME.LOADED) {\n            (_a = this.iframeHandshakePromise) === null || _a === void 0 ? void 0 : _a.resolve(data.payload);\n        }\n        else if (data.type === events_2.POPUP.BOOTSTRAP) {\n            if (this.openTimeout)\n                clearTimeout(this.openTimeout);\n        }\n        else if (data.type === events_2.POPUP.ERROR && this.popupWindow) {\n            const errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n            this.emit(events_2.POPUP.CLOSED, errorMessage ? `Popup error: ${errorMessage}` : null);\n            this.clear();\n        }\n        else if (data.type === events_2.POPUP.LOADED) {\n            if (this.openTimeout)\n                clearTimeout(this.openTimeout);\n            if (this.popupPromise) {\n                this.popupPromise.resolve();\n                this.popupPromise = undefined;\n            }\n            (_b = this.iframeHandshakePromise) === null || _b === void 0 ? void 0 : _b.promise.then(payload => {\n                this.channel.postMessage({\n                    type: events_2.POPUP.INIT,\n                    payload: Object.assign(Object.assign({}, payload), { settings: this.settings }),\n                });\n            });\n        }\n        else if (data.type === events_2.POPUP.CANCEL_POPUP_REQUEST) {\n            clearTimeout(this.requestTimeout);\n            if (this.popupPromise) {\n                this.close();\n            }\n        }\n        else if (data.type === events_2.UI.CLOSE_UI_WINDOW) {\n            this.clear(false);\n        }\n    }\n    clear(focus = true) {\n        this.locked = false;\n        this.popupPromise = undefined;\n        this.handshakePromise = (0, utils_1.createDeferred)();\n        if (this.channel) {\n            this.channel.disconnect();\n        }\n        if (this.requestTimeout) {\n            clearTimeout(this.requestTimeout);\n            this.requestTimeout = undefined;\n        }\n        if (this.openTimeout) {\n            clearTimeout(this.openTimeout);\n            this.openTimeout = undefined;\n        }\n        if (this.closeInterval) {\n            clearInterval(this.closeInterval);\n            this.closeInterval = undefined;\n        }\n        if (focus && this.extensionTabId) {\n            chrome.tabs.update(this.extensionTabId, { active: true });\n            this.extensionTabId = 0;\n        }\n    }\n    close() {\n        var _a;\n        if (!this.popupWindow)\n            return;\n        this.logger.debug('closing popup');\n        if (this.popupWindow.mode === 'tab') {\n            let _e = chrome.runtime.lastError;\n            if (this.popupWindow.tab.id) {\n                chrome.tabs.remove(this.popupWindow.tab.id, () => {\n                    _e = chrome.runtime.lastError;\n                    if (_e) {\n                        this.logger.error('closed with error', _e);\n                    }\n                });\n            }\n        }\n        else if (this.popupWindow.mode === 'window') {\n            this.popupWindow.window.close();\n        }\n        this.popupWindow = undefined;\n        if ((_a = this.settings) === null || _a === void 0 ? void 0 : _a.useCoreInPopup) {\n            this.channel.clear();\n        }\n    }\n    async postMessage(message) {\n        var _a, _b;\n        if (!this.popupWindow && message.type !== events_2.UI.REQUEST_UI_WINDOW && this.openTimeout) {\n            this.clear();\n            (0, showPopupRequest_1.showPopupRequest)(this.open.bind(this), () => {\n                this.emitClosed();\n            });\n            return;\n        }\n        if (this.popupPromise) {\n            await this.popupPromise.promise;\n        }\n        if (((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.mode) === 'window') {\n            this.popupWindow.window.postMessage(message, this.origin);\n        }\n        else if (((_b = this.popupWindow) === null || _b === void 0 ? void 0 : _b.mode) === 'tab') {\n            this.channel.postMessage(message);\n        }\n    }\n    isWebExtensionWithTab() {\n        var _a;\n        return (((_a = this.settings) === null || _a === void 0 ? void 0 : _a.env) === 'webextension' &&\n            typeof chrome !== 'undefined' &&\n            typeof (chrome === null || chrome === void 0 ? void 0 : chrome.tabs) !== 'undefined');\n    }\n    emitClosed() {\n        var _a;\n        if ((_a = this.settings) === null || _a === void 0 ? void 0 : _a.useCoreInPopup) {\n            this.channel.resolveMessagePromises({\n                code: 'Method_Interrupted',\n                error: events_2.POPUP.CLOSED,\n            });\n        }\n        this.emit(events_2.POPUP.CLOSED);\n    }\n}\nexports.PopupManager = PopupManager;\n//# sourceMappingURL=index.js.map"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}